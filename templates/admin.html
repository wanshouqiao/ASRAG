<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç®¡ç†ç«¯ - è¯­éŸ³RAGç³»ç»Ÿ</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif; margin: 0; background: #f5f6fa; }
    header { background:#2c3e50; color:#fff; padding:14px 18px; display:flex; align-items:center; justify-content:space-between; }
    header .title { font-weight:700; }
    header .right a, header .right button { color:#fff; margin-left:12px; background: transparent; border:1px solid rgba(255,255,255,.25); padding:6px 10px; border-radius:6px; cursor:pointer; }
    .container { max-width: 1080px; margin: 20px auto; padding: 0 16px 40px; }
    .card { background:#fff; border-radius:12px; box-shadow:0 4px 18px rgba(0,0,0,.06); padding:18px; margin-bottom:16px; }
    h2 { margin:0 0 14px; font-size:18px; color:#333; }
    .row { display:flex; gap:14px; align-items:center; flex-wrap:wrap; }
    label { color:#555; }
    select, textarea, input[type=text] { width:100%; max-width:520px; padding:10px; border-radius:6px; border:1px solid #ddd; font-size:14px; }
    button.primary { background:#4CAF50; color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }
    button.warn { background:#e74c3c; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .muted { color:#999; font-size:12px; }
    ul.files { list-style:none; padding:0; margin:0; }
    ul.files li { display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #f0f0f0; padding:10px 4px; }

    /* ç™»å½•é®ç½© */
    .login-mask { position:fixed; inset:0; background:#111827; display:flex; align-items:center; justify-content:center; }
    .login-panel { width: 92%; max-width: 360px; background:#fff; border-radius:12px; box-shadow:0 8px 32px rgba(0,0,0,.2); padding:22px; }
    .login-panel h3 { margin:0 0 12px; color:#111; }
    .login-panel input { width:100%; padding:10px; margin:8px 0; border:1px solid #ddd; border-radius:6px; }
    .login-panel button { width:100%; margin-top:8px; }
    .error { color:#e74c3c; font-size:13px; margin-top:6px; }
  </style>
</head>
<body>
  <header>
    <div class="title">ç®¡ç†ç«¯ - è¯­éŸ³ RAG ç³»ç»Ÿ</div>
    <div class="right">
      <a href="javascript:void(0)" onclick="window.location.href = window.API_PREFIX + '/'">ç”¨æˆ·ç«¯</a>
      <button id="btnLogout">é€€å‡ºç™»å½•</button>
    </div>
  </header>

  <div class="container">
    <div class="card" id="cardModel">
      <h2>æ¨¡å‹è®¾ç½®</h2>
      <div class="row">
        <label for="modelSelect">é€‰æ‹© LLM æ¨¡å‹ï¼š</label>
        <select id="modelSelect">
          <option value="gemma3-12b">Gemma3-12B</option>
          <option value="qwen2.5-7b">Qwen2.5-7B</option>
        </select>
        <span id="modelStatus" class="muted"></span>
      </div>
      
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
        <h3 style="margin: 0 0 12px; font-size: 16px; color: #444;">å·²é…ç½®çš„æ¨¡å‹</h3>
        <div id="modelList" style="margin-bottom: 20px;">
          <div class="muted">æ­£åœ¨åŠ è½½...</div>
        </div>
      </div>
      
      <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
        <h3 style="margin: 0 0 12px; font-size: 16px; color: #444;">æ·»åŠ æ–°æ¨¡å‹</h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <div>
            <label style="display: block; margin-bottom: 4px; color: #555; font-size: 13px;">æ¨¡å‹ IDï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰:</label>
            <input type="text" id="newModelId" placeholder="ä¾‹å¦‚: my-custom-model" style="width: 100%; max-width: 520px; padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 4px; color: #555; font-size: 13px;">API åœ°å€:</label>
            <input type="text" id="newModelApiBase" placeholder="ä¾‹å¦‚: http://localhost:8000" style="width: 100%; max-width: 520px; padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 4px; color: #555; font-size: 13px;">API Keyï¼ˆå¯é€‰ï¼‰:</label>
            <input type="text" id="newModelApiKey" placeholder="ç•™ç©ºè¡¨ç¤ºæ— éœ€è®¤è¯" style="width: 100%; max-width: 520px; padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px;" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 4px; color: #555; font-size: 13px;">æ¨¡å‹åç§°:</label>
            <input type="text" id="newModelName" placeholder="ä¾‹å¦‚: qwen2.5-7b-instruct" style="width: 100%; max-width: 520px; padding: 8px; border-radius: 6px; border: 1px solid #ddd; font-size: 14px;" />
          </div>
          <div>
            <label style="display: flex; align-items: center; gap: 8px; color: #555; font-size: 13px;">
              <input type="checkbox" id="newModelSupportsVision" style="width: auto;" />
              <span>æ”¯æŒå¤šæ¨¡æ€ï¼ˆå›¾ç‰‡è¾“å…¥ï¼‰</span>
            </label>
          </div>
          <div style="margin-top: 8px;">
            <button id="btnAddModel" class="primary" style="background: #2196F3;">æ·»åŠ æ¨¡å‹å¹¶åˆ‡æ¢</button>
            <span id="addModelStatus" class="muted"></span>
          </div>
        </div>
      </div>
    </div>

    <div class="card" id="cardHotwords">
      <h2>çƒ­è¯éƒ¨ç½²</h2>
      <div>
        <textarea id="hotwordsInput" rows="6" placeholder="æ¯è¡Œä¸€ä¸ªçƒ­è¯ï¼Œæœ€åå¯é€‰æƒé‡ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰\nç¤ºä¾‹ï¼š\né˜¿é‡Œå·´å·´ 20\nhello world 40"></textarea>
        <div class="muted">æç¤ºï¼šå°†ä¼šç”¨äº ASR çš„çƒ­è¯å¢å¼ºï¼Œæ ¼å¼ä¸ºâ€œçƒ­è¯ å¯é€‰æƒé‡â€ã€‚</div>
        <div style="margin-top:10px;">
          <button id="btnSaveHotwords" class="primary">ä¿å­˜çƒ­è¯</button>
          <span id="hotwordsStatus" class="muted"></span>
        </div>
      </div>
    </div>

    <div class="card" id="cardFiles">
      <h2>æ–‡ä»¶ç®¡ç† / çŸ¥è¯†åº“</h2>
      <div class="row">
        <input type="file" id="fileInput" accept=".txt,.md,.pdf,.jpg,.jpeg,.png,.webp,.gif,.bmp,image/*" />
        <button id="btnUpload" class="primary">ä¸Šä¼ å¹¶æ·»åŠ åˆ°çŸ¥è¯†åº“</button>
        <span id="uploadStatus" class="muted"></span>
      </div>
      <div style="margin-top:10px;">
        <h3 style="margin:0 0 8px; font-size:15px; color:#444;">å½“å‰çŸ¥è¯†åº“æ–‡ä»¶åˆ—è¡¨</h3>
        <ul id="fileList" class="files"><li class="muted">æ­£åœ¨åŠ è½½...</li></ul>
      </div>
    </div>
  </div>

  <!-- ç™»å½•é®ç½© -->
  <div id="loginMask" class="login-mask" style="display:none;">
    <div class="login-panel">
      <h3>ç®¡ç†å‘˜ç™»å½•</h3>
      <input id="loginUser" type="text" placeholder="ç”¨æˆ·å" />
      <input id="loginPass" type="password" placeholder="å¯†ç " />
      <button id="btnLogin" class="primary">ç™»å½•</button>
      <div id="loginError" class="error" style="display:none;"></div>
    </div>
  </div>

  <script>
    // åŠ¨æ€è·å– API å‰ç¼€ï¼Œé€‚é… /wsq ç­‰åå‘ä»£ç†è·¯å¾„
    // request.script_root ä¼šç”± Flask æ¸²æŸ“ä¸ºå®é™…çš„ SCRIPT_NAME (ä¾‹å¦‚ "/wsq" æˆ– "")
    window.API_PREFIX = "{{ request.script_root }}";

    // ==== ç®€æ˜“é‰´æƒï¼ˆéœ€è¦åç«¯æä¾› /api/login è¿”å› {success, token}ï¼‰====
    const LS_TOKEN_KEY = 'auth_token';
    function setToken(t){ if(t){ localStorage.setItem(LS_TOKEN_KEY, t); } }
    function getToken(){ return localStorage.getItem(LS_TOKEN_KEY) || ''; }
    function clearToken(){ localStorage.removeItem(LS_TOKEN_KEY); }
    function authHeaders(){ const t=getToken(); return t? { 'Authorization': 'Bearer '+t }: {}; }

    const loginMask = document.getElementById('loginMask');
    const loginUser = document.getElementById('loginUser');
    const loginPass = document.getElementById('loginPass');
    const btnLogin  = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const loginError= document.getElementById('loginError');

    async function ensureAuthed(){
      // ç²—ç•¥æ ¡éªŒï¼šå°è¯•æ‹‰å–æ¨¡å‹é…ç½®
      try{
        const r = await fetch(window.API_PREFIX + '/api/model', { 
          headers: { 'Content-Type':'application/json', ...authHeaders() },
          credentials: 'include'
        });
        const j = await r.json();
        if(j && (j.success!==false)) return true;
      }catch(_){ }
      return false;
    }

    function showLogin(){ loginMask.style.display='flex'; loginError.style.display='none'; loginError.textContent=''; }
    function hideLogin(){ loginMask.style.display='none'; }

    async function doLogin(){
      const u = loginUser.value.trim();
      const p = loginPass.value.trim();
      if(!u || !p){ loginError.textContent='è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç '; loginError.style.display='block'; return; }
      try{
        const r = await fetch(window.API_PREFIX + '/api/login', { 
          method:'POST', 
          headers:{'Content-Type':'application/json'}, 
          body: JSON.stringify({username:u,password:p}),
          credentials: 'include'
        });
        const j = await r.json();
        if(j && j.success && j.token){ setToken(j.token); hideLogin(); await initAdmin(); }
        else { loginError.textContent = 'ç™»å½•å¤±è´¥ï¼š'+(j && j.error || 'æœªçŸ¥é”™è¯¯'); loginError.style.display='block'; }
      }catch(e){ loginError.textContent='ç™»å½•å‡ºé”™ï¼š'+e.message; loginError.style.display='block'; }
    }

    btnLogin.onclick = doLogin;
    loginUser.addEventListener('keypress', (e)=>{ if(e.key==='Enter') doLogin(); });
    loginPass.addEventListener('keypress', (e)=>{ if(e.key==='Enter') doLogin(); });

    btnLogout.onclick = ()=>{ clearToken(); showLogin(); };

    // ==== ç®¡ç†åŠŸèƒ½ï¼šæ¨¡å‹ã€çƒ­è¯ã€æ–‡ä»¶ ====
    const modelSelect  = document.getElementById('modelSelect');
    const modelStatus  = document.getElementById('modelStatus');
    const hotwordsInput= document.getElementById('hotwordsInput');
    const btnSaveHot   = document.getElementById('btnSaveHotwords');
    const hotwordsStatus=document.getElementById('hotwordsStatus');
    const fileInput    = document.getElementById('fileInput');
    const btnUpload    = document.getElementById('btnUpload');
    const uploadStatus = document.getElementById('uploadStatus');
    const fileList     = document.getElementById('fileList');

    const modelList = document.getElementById('modelList');
    
    async function loadModelSettings(){
      try{
        const r = await fetch(window.API_PREFIX + '/api/model', { 
          headers: { 'Content-Type':'application/json', ...authHeaders() },
          credentials: 'include'
        });
        const j = await r.json();
        if(j && j.success){
          // æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨ï¼ŒåŒ…å«æ‰€æœ‰å¯ç”¨æ¨¡å‹
          modelSelect.innerHTML = '';
          const models = j.available_models || [];
          const modelsInfo = j.models_info || {};
          const currentModel = j.current_model || '';
          
          models.forEach(modelId => {
            const option = document.createElement('option');
            option.value = modelId;
            const info = modelsInfo[modelId] || {};
            const displayName = info.model_name ? `${modelId} (${info.model_name})` : modelId;
            option.textContent = displayName;
            modelSelect.appendChild(option);
          });
          
          // å¦‚æœåç«¯è¿”å›å½“å‰æ¨¡å‹ï¼Œåˆ™ä½¿ç”¨ï¼›å¦åˆ™é»˜è®¤åˆ°ç¬¬ä¸€ä¸ª
          modelSelect.value = currentModel || (models.length > 0 ? models[0] : '');
          modelSelect.dataset.prev = modelSelect.value; // è®°å½•ä¸Šä¸€æ¬¡æœ‰æ•ˆå€¼ï¼Œç”¨äºå›é€€
          
          // æ›´æ–°æ¨¡å‹åˆ—è¡¨æ˜¾ç¤º
          renderModelList(models, modelsInfo, currentModel);
        }
      }catch(e){ modelStatus.textContent='åŠ è½½å¤±è´¥'; }
    }
    
    function renderModelList(models, modelsInfo, currentModel){
      if(!models || models.length === 0){
        modelList.innerHTML = '<div class="muted">æš‚æ— æ¨¡å‹</div>';
        return;
      }
      
      let html = '<ul style="list-style: none; padding: 0; margin: 0;">';
      models.forEach(modelId => {
        const info = modelsInfo[modelId] || {};
        const isCurrent = modelId === currentModel;
        const isDefault = modelId === 'local';
        const canDelete = !isDefault && !isCurrent;
        
        html += `<li style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f0f0f0;">
          <div style="flex: 1;">
            <div style="font-weight: 500; color: #333;">
              ${modelId} ${isCurrent ? '<span style="color: #4CAF50; font-size: 0.85em;">(å½“å‰ä½¿ç”¨)</span>' : ''}
              ${isDefault ? '<span style="color: #999; font-size: 0.85em;">(é»˜è®¤æ¨¡å‹)</span>' : ''}
            </div>
            <div style="font-size: 0.85em; color: #666; margin-top: 4px;">
              æ¨¡å‹åç§°: ${info.model_name || 'N/A'} | API: ${info.api_base || 'N/A'}
              ${info.supports_vision ? ' | æ”¯æŒå¤šæ¨¡æ€' : ''}
            </div>
          </div>
          ${canDelete ? `<button onclick="deleteModel('${modelId}')" class="warn" style="margin-left: 10px;">åˆ é™¤</button>` : ''}
        </li>`;
      });
      html += '</ul>';
      modelList.innerHTML = html;
    }
    
    window.deleteModel = async function(modelId){
      if(!confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡å‹ "${modelId}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) return;
      
      try{
        const r = await fetch(window.API_PREFIX + '/api/model/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...authHeaders() },
          body: JSON.stringify({ model_id: modelId }),
          credentials: 'include'
        });
        const j = await r.json();
        if(j && j.success){
          alert('æ¨¡å‹å·²åˆ é™¤');
          await loadModelSettings(); // é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨
        } else {
          alert('åˆ é™¤å¤±è´¥ï¼š' + (j && j.error || 'æœªçŸ¥é”™è¯¯'));
        }
      }catch(e){
        alert('åˆ é™¤å‡ºé”™ï¼š' + e.message);
      }
    };
    modelSelect.addEventListener('change', async ()=>{
      const prev = modelSelect.dataset.prev || modelSelect.defaultValue || '';
      const modelType = modelSelect.value;
      modelStatus.textContent='æ­£åœ¨åˆ‡æ¢...';
      modelSelect.disabled = true;
      try{
        const r= await fetch(window.API_PREFIX + '/api/model',{ 
          method:'POST', 
          headers:{'Content-Type':'application/json', ...authHeaders()}, 
          body: JSON.stringify({model_type:modelType}),
          credentials: 'include'
        });
        const j= await r.json();
        if (j && j.success) {
          modelStatus.textContent = 'âœ… å·²åˆ‡æ¢';
          // é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨ä»¥ç¡®ä¿æœ€æ–°
          await loadModelSettings();
          // å¦‚æœåç«¯å›ä¼ å½“å‰æ¨¡å‹ï¼Œä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›å€¼
          if (j.current_model) modelSelect.value = j.current_model;
          modelSelect.dataset.prev = modelSelect.value;
        } else {
          modelStatus.textContent = 'âŒ å¤±è´¥';
          alert('åˆ‡æ¢å¤±è´¥ï¼š'+(j && j.error||'æœªçŸ¥é”™è¯¯'));
          modelSelect.value = prev; // å›é€€åˆ°ä¸Šä¸€æ¬¡æœ‰æ•ˆå€¼
        }
      }catch(e){ modelStatus.textContent='âŒ å‡ºé”™'; modelSelect.value = prev; }
      finally { modelSelect.disabled = false; setTimeout(()=>modelStatus.textContent='',2000); }
    });

    // æ·»åŠ æ–°æ¨¡å‹
    const btnAddModel = document.getElementById('btnAddModel');
    const addModelStatus = document.getElementById('addModelStatus');
    const newModelId = document.getElementById('newModelId');
    const newModelApiBase = document.getElementById('newModelApiBase');
    const newModelApiKey = document.getElementById('newModelApiKey');
    const newModelName = document.getElementById('newModelName');
    const newModelSupportsVision = document.getElementById('newModelSupportsVision');

    btnAddModel.onclick = async ()=>{
      const modelId = newModelId.value.trim();
      const apiBase = newModelApiBase.value.trim();
      const apiKey = newModelApiKey.value.trim();
      const modelName = newModelName.value.trim();
      const supportsVision = newModelSupportsVision.checked;

      if(!modelId){
        addModelStatus.textContent='âŒ è¯·è¾“å…¥æ¨¡å‹ ID';
        setTimeout(()=> addModelStatus.textContent='', 3000);
        return;
      }
      if(!apiBase){
        addModelStatus.textContent='âŒ è¯·è¾“å…¥ API åœ°å€';
        setTimeout(()=> addModelStatus.textContent='', 3000);
        return;
      }
      if(!modelName){
        addModelStatus.textContent='âŒ è¯·è¾“å…¥æ¨¡å‹åç§°';
        setTimeout(()=> addModelStatus.textContent='', 3000);
        return;
      }

      addModelStatus.textContent='æ­£åœ¨æ·»åŠ ...';
      btnAddModel.disabled = true;
      try{
        const r = await fetch(window.API_PREFIX + '/api/model/add', {
          method:'POST',
          headers:{'Content-Type':'application/json', ...authHeaders()},
          body: JSON.stringify({
            model_id: modelId,
            api_base: apiBase,
            api_key: apiKey,
            model_name: modelName,
            supports_vision: supportsVision
          }),
          credentials: 'include'
        });
        const j = await r.json();
        if(j && j.success){
          addModelStatus.textContent='âœ… å·²æ·»åŠ å¹¶åˆ‡æ¢';
          // æ¸…ç©ºè¡¨å•
          newModelId.value = '';
          newModelApiBase.value = '';
          newModelApiKey.value = '';
          newModelName.value = '';
          newModelSupportsVision.checked = false;
          // é‡æ–°åŠ è½½æ¨¡å‹åˆ—è¡¨
          await loadModelSettings();
          modelStatus.textContent = 'âœ… å·²åˆ‡æ¢åˆ°æ–°æ¨¡å‹';
          setTimeout(()=> { modelStatus.textContent=''; addModelStatus.textContent=''; }, 2000);
        } else {
          addModelStatus.textContent='âŒ å¤±è´¥ï¼š'+(j && j.error || 'æœªçŸ¥é”™è¯¯');
        }
        setTimeout(()=> addModelStatus.textContent='', 5000);
      }catch(e){
        addModelStatus.textContent='âŒ å‡ºé”™ï¼š'+e.message;
        setTimeout(()=> addModelStatus.textContent='', 5000);
      }finally{
        btnAddModel.disabled = false;
      }
    };

    async function loadHotwords(){
      try{
        const r = await fetch(window.API_PREFIX + '/api/hotwords', { 
          headers: { ...authHeaders() },
          credentials: 'include'
        });
        const j = await r.json();
        if(j && j.hotwords){ hotwordsInput.value = j.hotwords; }
      }catch(_){ }
    }
    btnSaveHot.onclick = async ()=>{
      try{
        hotwordsStatus.textContent='ä¿å­˜ä¸­...';
        const r = await fetch(window.API_PREFIX + '/api/hotwords', { 
          method:'POST', 
          headers:{'Content-Type':'application/json', ...authHeaders()}, 
          body: JSON.stringify({hotwords: hotwordsInput.value}),
          credentials: 'include'
        });
        const j = await r.json();
        hotwordsStatus.textContent = j && j.success ? 'âœ… å·²ä¿å­˜' : 'âŒ å¤±è´¥';
        setTimeout(()=> hotwordsStatus.textContent='', 2000);
      }catch(e){ hotwordsStatus.textContent='âŒ å‡ºé”™'; }
    };

    async function loadFiles(){
      try{
        fileList.innerHTML = '<li class="muted">åŠ è½½ä¸­...</li>';
        const r = await fetch(window.API_PREFIX + '/api/files', { 
          headers: { ...authHeaders() },
          credentials: 'include'
        });
        const j = await r.json();
        if(!j || !j.success){ fileList.innerHTML='<li class="muted">åŠ è½½å¤±è´¥</li>'; return; }
        const arr = j.files || [];
        if(arr.length===0){ fileList.innerHTML='<li class="muted">æš‚æ— æ–‡ä»¶</li>'; return; }
        fileList.innerHTML = arr.map(f=>{
          const date = new Date(f.mtime*1000).toLocaleString();
          const size = (f.size/1024).toFixed(1)+' KB';
          const fileType = f.file_type || 'document';
          const typeIcon = fileType === 'image' ? 'ğŸ–¼ï¸' : 'ğŸ“„';
          const typeLabel = fileType === 'image' ? 'å›¾ç‰‡' : 'æ–‡æ¡£';
          const safeName = (f.name || '').replace(/'/g, "\\'");
          return `<li><div><div>${typeIcon} ${f.name} <span class='muted'>(${typeLabel})</span></div><div class='muted'>${date} Â· ${size}</div></div><button class='warn' onclick="deleteFile(this,'${safeName}','${fileType}')">åˆ é™¤</button></li>`;
        }).join('');
      }catch(e){ fileList.innerHTML='<li class="muted">åŠ è½½å‡ºé”™</li>'; }
    }

    window.deleteFile = async function(btn, filename, fileType){
      const fileTypeLabel = fileType === 'image' ? 'å›¾ç‰‡' : 'æ–‡æ¡£';
      if(!confirm(`ç¡®å®šè¦åˆ é™¤${fileTypeLabel} "${filename}" å—ï¼Ÿè¿™å°†é‡å»ºçŸ¥è¯†åº“ï¼Œå¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´ã€‚`)) return;
      try{
        const ori = btn.textContent; btn.textContent='åˆ é™¤ä¸­...'; btn.disabled=true;
        const r = await fetch(window.API_PREFIX + '/api/files',{ 
          method:'DELETE', 
          headers:{'Content-Type':'application/json', ...authHeaders()}, 
          body: JSON.stringify({filename, file_type:fileType}),
          credentials: 'include'
        });
        const j = await r.json();
        if(j && j.success){ await loadFiles(); }
        else { alert('åˆ é™¤å¤±è´¥ï¼š'+(j && j.error||'æœªçŸ¥é”™è¯¯')); btn.textContent=ori; btn.disabled=false; }
      }catch(e){ alert('åˆ é™¤å‡ºé”™ï¼š'+e.message); btn.textContent='åˆ é™¤'; btn.disabled=false; }
    };

    btnUpload.onclick = async ()=>{
      if(!fileInput.files || fileInput.files.length===0){ alert('è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶'); return; }
      const form = new FormData(); form.append('file', fileInput.files[0]);
      uploadStatus.textContent='ä¸Šä¼ ä¸­...';
      try{
        const r = await fetch(window.API_PREFIX + '/api/upload_kb', { 
          method:'POST', 
          headers: { ...authHeaders() }, 
          body: form,
          credentials: 'include'
        });
        const j = await r.json();
        if(j && j.success){ uploadStatus.textContent='âœ… ä¸Šä¼ æˆåŠŸ'; fileInput.value=''; await loadFiles(); }
        else { uploadStatus.textContent='âŒ ä¸Šä¼ å¤±è´¥ï¼š'+(j && j.error || 'æœªçŸ¥é”™è¯¯'); }
      }catch(e){ uploadStatus.textContent='âŒ å‡ºé”™ï¼š'+e.message; }
    };

    async function initAdmin(){
      const authed = await ensureAuthed();
      if(!authed){ showLogin(); return; }
      hideLogin();
      await Promise.all([loadModelSettings(), loadHotwords(), loadFiles()]);
    }

    (async ()=>{
      // åˆå§‹ï¼šå¦‚æœå·²æœ‰tokenï¼Œå°è¯•ç›´æ¥è¿›å…¥ï¼›å¦åˆ™æ˜¾ç¤ºç™»å½•
      const ok = await ensureAuthed();
      if(ok) await initAdmin(); else showLogin();
    })();
  </script>
</body>
</html>

